{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-4">Admin Dashboard</h1>

  <!-- ====== Report Generation Buttons ====== -->
  <div class="text-end mb-4 d-flex justify-content-end gap-2">
    <!-- Remove export_all_data_csv since it no longer exists -->
    <!-- <form method="post" class="d-inline">
      {% csrf_token %}
      <input type="hidden" name="action" value="generate_async_reports">
      <button type="submit" class="btn btn-info">Generate Async Student Reports</button>
    </form> -->

    
  </div>

  <!-- ====== USER MANAGEMENT ====== -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h4>User Management</h4>
    </div>
    <div class="card-body">
      <form method="post" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_user">
        {{ user_form.as_p }}
        <button type="submit" class="btn btn-primary">Create User</button>
      </form>

      <h5>Existing Users</h5>
      <table class="table table-striped table-bordered">
        <thead>
          <tr><th>Name</th><th>Role</th><th>Email</th><th>Action</th></tr>
        </thead>
        <tbody>
          {% for p in students %}
          <tr>
            <td>{{ p.user.username }}</td>
            <td>Student</td>
            <td>{{ p.user.email }}</td>
            <td>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="profile_id" value="{{ p.id }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% for p in lecturers %}
          <tr>
            <td>{{ p.user.username }}</td>
            <td>Lecturer</td>
            <td>{{ p.user.email }}</td>
            <td>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="profile_id" value="{{ p.id }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% for p in admins %}
          <tr>
            <td>{{ p.user.username }}</td>
            <td>Admin</td>
            <td>{{ p.user.email }}</td>
            <td>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="profile_id" value="{{ p.id }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ====== COURSE & MARK MANAGEMENT ====== -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white">
      <h4>Courses & Marks Management</h4>
    </div>
    <div class="card-body">

      <!-- Add Course -->
      <h5>Add New Course</h5>
      <form method="post" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="course_form">
        {{ course_form.as_p }}
        <button type="submit" class="btn btn-success">Add Course</button>
      </form>

      <!-- Add Marks -->
      <h5>Enter Student Marks</h5>
      <form method="post" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="student_mark_form">
        {{ student_mark_form.as_p }}
        <button type="submit" class="btn btn-dark">Save Mark</button>
      </form>

      <!-- Combined Table -->
      <h5>Courses & Student Marks</h5>
      <table class="table table-bordered table-striped table-sm">
        <thead class="table-dark">
          <tr>
            <th>Student</th>
            <th>Course</th>
            <th>Lecturer</th>
            <th>Score</th>
            <th>Grade</th>
            <th>GPA</th>
            <th>CPA</th>
          </tr>
        </thead>
        <tbody>
          {% for mark in marks %}
          <tr>
            <td>{{ mark.student.user.username }}</td>
            <td>{{ mark.course.code }} - {{ mark.course.name }}</td>
            <td>{{ mark.lecturer.user.username }}</td>
            <td>{{ mark.score }}</td>
            <td>{{ mark.grade }}</td>
            <td>{{ mark.gpa|floatformat:2 }}</td>
            <td>{{ mark.cpa|floatformat:2 }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-center">No marks recorded yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<form method="get" action="{% url 'download_processed_marks_csv' %}">
    <button type="submit" class="btn btn-success mb-3">Download Processed Marksheet (CSV)</button>
</form>
<form method="post">{% csrf_token %}
  <input type="hidden" name="action" value="generate_student_reports_zip">
  <button class="btn btn-primary">Generate Student PDFs (ZIP)</button>
</form>

<form method="post">
  {% csrf_token %}
  <input type="hidden" name="action" value="send_all_reports_email">
  <button type="submit" class="btn btn-success">Send Reports by Email</button>
</form>

<form method="post" class="d-inline">
  {% csrf_token %}
  <input type="hidden" name="action" value="upload_reports_to_cloud">
  <button type="submit" class="btn btn-success">Push Latest Reports to Cloud</button>
</form>
{% endblock %}

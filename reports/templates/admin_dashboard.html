{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-4">Admin Dashboard</h1>

  <!-- ====== Export Section ====== -->
  <div class="text-end mb-4">
    <a href="{% url 'export_all_data_csv' %}" class="btn btn-success">
      Export All Data (CSV)
    </a>
  </div>

  <!-- ====== USER MANAGEMENT ====== -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h4>User Management</h4>
    </div>
    <div class="card-body">
      <form method="post" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_user">
        {{ user_form.as_p }}
        <button type="submit" class="btn btn-primary">Create User</button>
      </form>

      <h5>Existing Users</h5>
      <table class="table table-striped table-bordered">
        <thead>
          <tr><th>Name</th><th>Role</th><th>Email</th><th>Action</th></tr>
        </thead>
        <tbody>
          {% for p in students %}
          <tr>
            <td>{{ p.user.username }}</td>
            <td>Student</td>
            <td>{{ p.user.email }}</td>
            <td>
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="profile_id" value="{{ p.id }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% for p in lecturers %}
          <tr>
            <td>{{ p.user.username }}</td>
            <td>Lecturer</td>
            <td>{{ p.user.email }}</td>
            <td>
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="profile_id" value="{{ p.id }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% for p in admins %}
          <tr>
            <td>{{ p.user.username }}</td>
            <td>Admin</td>
            <td>{{ p.user.email }}</td>
            <td>
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="profile_id" value="{{ p.id }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ====== COURSE MANAGEMENT ====== -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <h4>Course Management</h4>
      <a href="{% url 'export_all_data_csv' %}" class="btn btn-outline-light btn-sm">Export CSV</a>
    </div>
    <div class="card-body">
      <form method="post" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="course_form">
        {{ course_form.as_p }}
        <button type="submit" class="btn btn-info">Add Course</button>
      </form>

      <h5>Existing Courses</h5>
      <table class="table table-striped">
        <thead><tr><th>Code</th><th>Name</th><th>Lecturer</th><th>Students</th></tr></thead>
        <tbody>
          {% for c in courses %}
          <tr>
            <td>{{ c.code }}</td>
            <td>{{ c.name }}</td>
            <td>{{ c.lecturer }}</td>
            <td>
              {% for s in c.students.all %}
                {{ s.user.username }}{% if not forloop.last %}, {% endif %}
              {% empty %}
                <em>No students</em>
              {% endfor %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

<!-- ====== STUDENT MARKS & PERFORMANCE ====== -->
<!-- <div class="card mb-4">
  <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
    <h4>Student Marks & Performance</h4>
    <a href="{% url 'export_all_data_csv' %}" class="btn btn-outline-light btn-sm">ðŸ“¥ Export Marks CSV</a>
  </div>

  <div class="card-body">
    <form method="post" class="row g-3 mb-4">
      {% csrf_token %}
      <input type="hidden" name="action" value="student_mark_form">

      <div class="col-md-4">
        <label for="student" class="form-label fw-semibold">Student:</label>
        {{ student_mark_form.student }}
      </div>

      <div class="col-md-4">
        <label for="course" class="form-label fw-semibold">Course:</label>
        {{ student_mark_form.course }}
      </div>

      <div class="col-md-3">
        <label for="lecturer" class="form-label fw-semibold">Lecturer:</label>
        {{ student_mark_form.lecturer }}
      </div>

      <div class="col-md-3">
        <label for="score" class="form-label fw-semibold">Score:</label>
        {{ student_mark_form.score }}
      </div>

      <div class="col-12 mt-3">
        <button type="submit" class="btn btn-dark px-4">ðŸ’¾ Save Mark</button>
      </div>
    </form>

    <h5 class="mt-4">All Marks</h5>
    <table class="table table-bordered table-sm table-striped">
      <thead class="table-dark">
        <tr>
          <th>Student</th>
          <th>Course</th>
          <th>Lecturer</th>
          <th>Score</th>
          <th>Grade</th>
          <th>GPA</th>
        </tr>
      </thead>
      <tbody>
        {% for mark in marks %}
        <tr>
          <td>{{ mark.student.user.username }}</td>
          <td>{{ mark.course.name }}</td>
          <td>{{ mark.lecturer.user.username }}</td>
          <td>{{ mark.score }}</td>
          <td>{{ mark.grade }}</td>
          <td>{{ mark.gpa|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center">No marks yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <hr>
    <h5> GPA / CPA Summary by Student</h5>
    <table class="table table-bordered table-striped table-sm">
      <thead class="table-light">
        <tr><th>Student</th><th>GPA</th><th>CPA</th></tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr>
          <td>{{ s.user.username }}</td>
          <td>{{ s.gpa|floatformat:2 }}</td>
          <td>{{ s.cpa|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="text-center">No performance data.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
 -->
<!-- === COURSES & MARKS === -->
<div class="card mb-4">
  <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
    <h4>Courses & Marks Management</h4>
  </div>
  <div class="card-body">
    
    <!-- Add Course -->
    <h5>Add New Course</h5>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="course_form">
      {% csrf_token %}
      <input type="hidden" name="action" value="student_mark_form">
      {{ student_mark_form.as_p }}
      <button type="submit" class="btn btn-dark">Save Mark</button>
      <!-- {{ course_form.as_p }} -->
      <!-- <button type="submit" class="btn btn-success">Add Course</button> -->
    </form>

    <!-- <hr> -->

    <!-- Add Marks -->
    <!-- <h5>Enter Student Marks</h5> -->
    <!-- <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="student_mark_form">
      {{ student_mark_form.as_p }}
      <button type="submit" class="btn btn-dark">Save Mark</button>
    </form> -->

    <!-- <hr> -->

    <!-- Display Combined Table -->
    <h5>Courses & Student Marks</h5>
    <table class="table table-bordered table-striped table-sm">
      <thead class="table-dark">
        <tr>
          <th>Student</th>
          <th>Course</th>
          <th>Lecturer</th>
          <th>Score</th>
          <th>Grade</th>
          <th>GPA</th>
        </tr>
      </thead>
      <tbody>
        {% for mark in marks %}
        <tr>
          <td>{{ mark.student.user.username }}</td>
          <td>{{ mark.course.code }} - {{ mark.course.name }}</td>
          <td>{{ mark.lecturer.user.username }}</td>
          <td>{{ mark.score }}</td>
          <td>{{ mark.grade }}</td>
          <td>{{ mark.gpa|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center">No marks recorded yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

  <!-- ====== CLUBS ====== -->
  <div class="card mb-4">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h4>Clubs</h4>
      <a href="{% url 'export_all_data_csv' %}" class="btn btn-outline-light btn-sm">Export CSV</a>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="club_form">
        {{ club_form.as_p }}
        <button type="submit" class="btn btn-secondary">Add Club</button>
      </form>
      <hr>
      <table class="table table-striped">
        <thead><tr><th>Name</th><th>Description</th></tr></thead>
        <tbody>
          {% for club in clubs %}
          <tr><td>{{ club.name }}</td><td>{{ club.description }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ====== CAREER OPPORTUNITIES ====== -->
  <div class="card mb-4">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <h4>Career Opportunities</h4>
      <a href="{% url 'export_all_data_csv' %}" class="btn btn-outline-dark btn-sm">Export CSV</a>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="opportunity_form">
        {{ opportunity_form.as_p }}
        <button type="submit" class="btn btn-warning text-dark">Add Opportunity</button>
      </form>
      <hr>
      <table class="table table-striped">
        <thead><tr><th>Company</th><th>Role</th><th>Deadline</th></tr></thead>
        <tbody>
          {% for o in opportunities %}
          <tr><td>{{ o.company }}</td><td>{{ o.role }}</td><td>{{ o.deadline }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ====== ACHIEVEMENTS ====== -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <h4>Achievements</h4>
      <a href="{% url 'export_all_data_csv' %}" class="btn btn-outline-light btn-sm">Export CSV</a>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="achievement_form">
        {{ achievement_form.as_p }}
        <button type="submit" class="btn btn-success">Add Achievement</button>
      </form>
      <hr>
      <table class="table table-striped">
        <thead><tr><th>Student</th><th>Title</th><th>Description</th></tr></thead>
        <tbody>
          {% for a in achievements %}
          <tr><td>{{ a.student.user.username }}</td><td>{{ a.title }}</td><td>{{ a.description }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ====== SUPPORT TICKETS ====== -->
  <div class="card mb-5">
    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
      <h4>Support Tickets</h4>
      <a href="{% url 'export_all_data_csv' %}" class="btn btn-outline-light btn-sm">Export CSV</a>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="ticket_form">
        {{ ticket_form.as_p }}
        <button type="submit" class="btn btn-danger">Add Ticket</button>
      </form>
      <hr>
      <table class="table table-striped">
        <thead><tr><th>Student</th><th>Title</th><th>Status</th></tr></thead>
        <tbody>
          {% for t in tickets %}
          <tr><td>{{ t.student.user.username }}</td><td>{{ t.title }}</td><td>{{ t.status }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
